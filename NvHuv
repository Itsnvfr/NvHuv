-- [[ UTILITIES ]]
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()
local Camera = workspace.CurrentCamera

-- [[ MASTER CONFIG ]]
local Config = {
    Aimbot = {Enabled = false, Smooth = 0.5, Shake = 0.02, Part = "Head", Team = true, Wall = true, Alive = true, FOV = 80}, -- Lowered FOV and increased smoothness
    Silent = {Enabled = false, HitChance = 85, Team = true, Wall = true, Alive = true, FOV = 100}, -- Lowered HitChance for safety
    Trigger = {Enabled = false, Team = true, Wall = true, Alive = true, Delay = 0.15},
    Visuals = {Chams = false, HeadDot = false, Team = true, Color = Color3.fromRGB(0, 255, 255)},
    UI = {Visible = true}
}

-- [[ MODERN GLASS UI FRAMEWORK ]]
local ScreenGui = Instance.new("ScreenGui", game:GetService("CoreGui"))
local Main = Instance.new("Frame", ScreenGui)
Main.Size = UDim2.new(0, 650, 0, 450)
Main.Position = UDim2.new(0.5, -325, 0.5, -225)
Main.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
Main.BackgroundTransparency = 0.4 
Main.BorderSizePixel = 0

local Blur = Instance.new("BlurEffect", game:GetService("Lighting"))
Blur.Size = 0 -- Default off to save FPS
local Corner = Instance.new("UICorner", Main)
Corner.CornerRadius = UDim.new(0, 15)

-- [[ OPTIMIZED VALIDATION ENGINE ]]
local function IsValid(plr, cfg)
    if not plr or not plr.Character or not plr.Character:FindFirstChild("Humanoid") then return false end
    if cfg.Alive and plr.Character.Humanoid.Health <= 0 then return false end
    if cfg.Team and plr.Team == LocalPlayer.Team then return false end
    
    local part = plr.Character:FindFirstChild(Config.Aimbot.Part)
    if not part then return false end
    
    if cfg.Wall then
        local castPoints = {part.Position, Camera.CFrame.Position}
        local ignoreList = {LocalPlayer.Character, Camera}
        local ray = Ray.new(castPoints[2], (castPoints[1] - castPoints[2]).Unit * 1000)
        local hit = workspace:FindPartOnRayWithIgnoreList(ray, ignoreList)
        if hit and not hit:IsDescendantOf(plr.Character) then return false end
    end
    
    return true
end

local function GetClosest(fov, cfg)
    local target, closest = nil, fov
    for _, v in pairs(Players:GetPlayers()) do
        if v ~= LocalPlayer and IsValid(v, cfg) then
            local part = v.Character:FindFirstChild(Config.Aimbot.Part)
            if part then
                local pos, onScreen = Camera:WorldToViewportPoint(part.Position)
                if onScreen then
                    local dist = (Vector2.new(pos.X, pos.Y) - Vector2.new(Mouse.X, Mouse.Y)).Magnitude
                    if dist < closest then
                        target = v
                        closest = dist
                    end
                end
            end
        end
    end
    return target
end

-- [[ SILENT AIM - CLEANER HOOK ]]
local oldNC
oldNC = hookmetamethod(game, "__namecall", function(self, ...)
    local method = getnamecallmethod()
    local args = {...}

    if not checkcaller() and Config.Silent.Enabled and (method == "Raycast" or method == "FindPartOnRay") then
        local target = GetClosest(Config.Silent.FOV, Config.Silent)
        if target and math.random(1,100) <= Config.Silent.HitChance then
            local tPos = target.Character.Head.Position
            if method == "Raycast" then
                args[2] = (tPos - args[1]).Unit * 1000
                return oldNC(self, unpack(args))
            end
        end
    end
    return oldNC(self, ...)
end)

-- [[ VISUALS CACHE (Prevents Pipeline Crash) ]]
local function UpdateESP()
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character then
            local char = p.Character
            -- Only handle Highlight if enabled to save CPU
            local highlight = char:FindFirstChild("ESP_Highlight")
            if Config.Visuals.Chams and IsValid(p, Config.Visuals) then
                if not highlight then
                    highlight = Instance.new("Highlight", char)
                    highlight.Name = "ESP_Highlight"
                end
                highlight.FillColor = Config.Visuals.Color
                highlight.Enabled = true
            elseif highlight then
                highlight.Enabled = false
            end
        end
    end
end

-- [[ MAIN EXECUTION LOOP ]]
RunService.RenderStepped:Connect(function()
    -- 1. Aimbot (High Smoothness/Low Intensity)
    if Config.Aimbot.Enabled then
        local target = GetClosest(Config.Aimbot.FOV, Config.Aimbot)
        if target then
            local targetPart = target.Character[Config.Aimbot.Part]
            local pos = targetPart.Position
            local shake = Vector3.new(math.random(-1,1), math.random(-1,1), math.random(-1,1)) * Config.Aimbot.Shake
            -- Slower Lerp for "Lower Boost" feel
            Camera.CFrame = Camera.CFrame:Lerp(CFrame.new(Camera.CFrame.Position, pos + shake), Config.Aimbot.Smooth / 10)
        end
    end

    -- 2. Triggerbot (Thread-Safe)
    if Config.Trigger.Enabled then
        local targetPlr = Players:GetPlayerFromCharacter(Mouse.Target and Mouse.Target.Parent)
        if targetPlr and IsValid(targetPlr, Config.Trigger) then
            task.spawn(function()
                task.wait(Config.Trigger.Delay)
                mouse1click()
            end)
        end
    end
end)

-- Run ESP update less frequently to prevent crashing
task.spawn(function()
    while task.wait(0.5) do
        UpdateESP()
    end
end)

-- [[ UI TOGGLE ]]
UIS.InputBegan:Connect(function(input, gpe)
    if not gpe and input.KeyCode == Enum.KeyCode.RightShift then
        Config.UI.Visible = not Config.UI.Visible
        Main.Visible = Config.UI.Visible
        Blur.Enabled = Config.UI.Visible
        Blur.Size = Config.UI.Visible and 20 or 0
    end
end)

print("Rivals Glass Hub V2 | Optimized for Pipeline Safety")
